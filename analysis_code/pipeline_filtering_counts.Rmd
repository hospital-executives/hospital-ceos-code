---
title: "pipeline_filtering_counts"
output: html_document
date: "2024-09-25"
params:
  code_dir: "None" # #to make compatible with R file
---

# To prepare a clean and final HIMSS dataset for analysis, our pipepline applies a series of logical filters. These filters remove entries for contacts with uncertain data, and leave only those which we are confident have quality entries. At the end of the pipeline, the final dataset therefore has far fewer entries.This script counts the number of observations in all the interim files produced throughout the pipeline filtering. 

```{r manual set up}
#User entry required!

#clear environment
rm(list = setdiff(ls(), c("params"))) # #to make compatible with R file

# *** IMPORTING FILES ***
file_entities_contacts_0517 <- c("himss_entities_contacts_0517_v1.feather")

file_r_confirmed <- c("r_confirmed.feather")
file_r_remaining <- c("r_remaining.feather")

# file_py_confirmed <- c("py_confirmed.csv")
# file_py_remaining <- c("py_remaining.csv")

file_final_himss <- c("final_himss.feather")
file_final_confirmed <- c("final_confirmed.dta")

```

```{r setup, include=FALSE}
# NO manual entry required. This automatically loads necessary libraries and detects file paths. 

knitr::opts_chunk$set(echo = TRUE)

# Source the configuration script
# Check if rstudioapi is installed and install if necessary
if (!requireNamespace("rstudioapi", quietly = TRUE)) {
  install.packages("rstudioapi")
}

library(rstudioapi)

# Detect the path to the current script's directory dynamically
# script_directory <- dirname(rstudioapi::getActiveDocumentContext()$path)

# Detect the path to the current script's directory dynamically
# Updated for compatability with makefile
if (rstudioapi::isAvailable()) {
  script_directory <- dirname(rstudioapi::getActiveDocumentContext()$path)
} else {
  # Provide a fallback path or set a default
  script_directory <- params$code_dir
}

# Construct the path to the config.R file
config_path <- file.path(script_directory, "config.R")

# Source the config file dynamically
source(config_path)

#Now all necessary libraries are loaded, and file paths are set

#clean up
rm(script_directory, config_path)
```

```{r load data}

entities_contacts_0517 <- read_feather(paste0(derived_data,"/",file_entities_contacts_0517))

r_confirmed <- read_feather(paste0(derived_data,"/",file_r_confirmed))
r_remaining <- read_feather(paste0(derived_data,"/",file_r_remaining))

# py_confirmed <- read_csv(paste0(derived_data,"/",file_py_confirmed))
# py_remaining <- read_csv(paste0(derived_data,"/",file_py_remaining))

final_himss <- read_feather(paste0(derived_data,"/",file_final_himss))
final_confirmed <- read_dta(paste0(derived_data,"/",file_final_confirmed))
```

```{r function to count obs by entity_type}
count_hospital_rds <- function(df, col) {
  # Count obs containing "Hospital" or "RDS"
  hospital_rds_count <- df %>%
    filter(str_detect({{ col }}, "Hospital|RDS")) %>%
    count()

  # Count obs not containing "Hospital" or "RDS"
  non_hospital_rds_count <- df %>%
    filter(!str_detect({{ col }}, "Hospital|RDS")) %>%
    count()

  # Return the counts as a list
  list(
    hospital_rds = hospital_rds_count$n,
    non_hospital_rds = non_hospital_rds_count$n,
    total_count = nrow(df)
  )
}

```

```{r apply function to all dataframes}
# List of all dataframes to process
dfs <- list(
  entities_contacts_0517 = entities_contacts_0517,
  r_confirmed = r_confirmed,
  # r_remaining = r_remaining,
  py_confirmed = py_confirmed,
  py_remaining = py_remaining,
  final_himss = final_himss
)

# Apply the count_hospital_rds function to all dataframes
results <- map(dfs, ~count_hospital_rds(.x, entity_type))

# Extract just the hospital counts and convert to a dataframe for plotting
hospital_counts <- tibble(
  dataframe = names(dfs),
  hospital_rds_count = map_dbl(results, "hospital_rds")
)

# View the result
hospital_counts


```
```{r plot the counts}

# Create a horizontal bar chart with value labels, extended axis, and reduced font size for the labels
ggplot(hospital_counts, aes(x = reorder(dataframe, -hospital_rds_count), y = hospital_rds_count)) +
  geom_bar(stat = "identity") +
  coord_flip() + # Flip the axes for horizontal bars
  geom_text(aes(label = hospital_rds_count), hjust = -0.01, size = 3) + # Reduce font size for labels
  scale_y_continuous(labels = label_number(), expand = expansion(mult = c(0, 0.1))) + # Extend the axis slightly
  labs(
    title = "Hospital Counts by Dataframe",
    x = "Dataframe",
    y = "Hospital Count"
  ) +
  theme_minimal() +
  theme(plot.margin = unit(c(1, 1, 1, 1), "cm")) # Adjust margin to fit the labels

```

